name: Pharmacy Dashboard CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test & Build
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”§ Install Node.js dependencies
      run: |
        cd client
        npm ci --prefer-offline --no-audit
    
    - name: ğŸ§ª Test Python backend imports
      run: |
        python -c "
        try:
            import app
            import pandas as pd
            import flask
            import requests
            print('âœ… All backend imports successful')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
    
    - name: ğŸ—ï¸ Build React frontend
      run: |
        cd client
        npm run build
    
    - name: âœ… Verify build artifacts
      run: |
        test -f client/build/index.html
        test -d client/build/static
        echo "âœ… Build artifacts verified successfully"

  integration-test:
    runs-on: ubuntu-latest
    needs: test-and-build
    name: ğŸš€ Integration Test
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸƒâ€â™‚ï¸ Start Flask server
      run: |
        echo "ğŸš€ Starting Flask server..."
        export FLASK_ENV=development
        python app.py &
        echo "â³ Waiting for server to start..."
        sleep 10
    
    - name: ğŸ©º Health check
      run: |
        echo "ğŸ” Testing health endpoint..."
        curl -f http://localhost:5000/api/health || exit 1
        echo "âœ… Health check passed"
    
    - name: ğŸ§ª Test API endpoints
      run: |
        echo "ğŸ” Testing API endpoints..."
        curl -f http://localhost:5000/api/config/google-drive-url || exit 1
        echo "âœ… Configuration endpoint working"
    
    - name: ğŸ›‘ Cleanup
      if: always()
      run: |
        pkill -f "python app.py" || true

  deploy-ready:
    runs-on: ubuntu-latest
    needs: [test-and-build, integration-test]
    name: ğŸš€ Deploy Ready
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ‰ Deployment Ready
      run: |
        echo "ğŸ‰ All tests passed! Ready for deployment."
        echo "ğŸŒ Render will automatically deploy from this push."
        echo "ğŸ“Š Dashboard will be available at your Render URL."
        echo "â˜ï¸ Don't forget to configure GOOGLE_DRIVE_CSV_URL if using Google Drive integration."
        echo "ğŸ”— Check your Render dashboard for deployment progress."
